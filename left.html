<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Year Left</title>
    <link rel="stylesheet" type="text/css" href="style.css" />
    <style>
      :root {
        /* Fixed sizes: dots never change size */
        --dot-size: 8px;
        --gap: 6px; /* updated by JS; only spacing changes */
        --panel-bg: #f7f7f4; /* light background for cards */
        --accent-dark: #EEEEEC; /* dark mode accent for dots/text */
        --footer-color: inherit;
      }

      /* App-specific layout (minimal; uses site styles) */
      .card {
        position: fixed;
        top: 4vh; /* small space from top */
        left: 50%;
        transform: translateX(-50%);
        width: min(90vw, 600px);
        height: 70vh; /* 70% viewport height */
        min-width: 300px; /* enforce minimum width; grid/footer follow */
        border-radius: 28px;
        background: var(--panel-bg);
        box-shadow: inset 0 0 0 1px rgba(0,0,0,0.05);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start; /* grid top aligned */
        padding: 2rem;
        box-sizing: border-box;
        overflow: hidden; /* keep content inside */
        z-index: 1;
      }

      .grid {
        display: grid;
        grid-auto-rows: var(--dot-size);
        gap: var(--gap); /* updated by JS */
        margin: 0; /* positioned by card */
      }

      .dot {
        width: var(--dot-size);
        height: var(--dot-size);
        border-radius: 50%;
        background: #111110; /* visible in light mode too (site text color is dark) */
      }
      /* Glyph-based symbols */
      .dot.glyph {
        background: none;
        border-radius: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: calc(var(--dot-size) + 2px);
        line-height: 1;
        color: #111110;
      }
      .dot.past { opacity: 0.5; }

      /* Bottom labels pinned to viewport edges (match site padding) */
      .bottom {
        position: absolute; /* inside the card */
        bottom: 1.25rem;
        left: 50%;
        transform: translateX(-50%);
        width: var(--footer-width, auto);
        display: flex;
        justify-content: space-between;
        align-items: center;
        opacity: 1; /* match full-opacity future dots */
        color: var(--footer-color);
        font-size: 0.95em;
        pointer-events: auto; /* allow clicking/tapping labels */
        z-index: 2;
      }

      /* Respect dark mode */
      @media (prefers-color-scheme: dark) {
        .dot { background: var(--accent-dark, #EEEEEC); }
        .dot.glyph { color: var(--accent-dark, #EEEEEC); }
        .card {
          background: #141413;
          box-shadow: inset 0 0 0 1px rgba(255,255,255,0.06);
        }
        .bottom { opacity: 1; color: var(--accent-dark, #EEEEEC); }
      }

      /* Actions card at the bottom (10% viewport height) */
      .actions-card {
        position: fixed;
        left: 50%;
        transform: translateX(-50%);
        bottom: 2vh;
        width: min(90vw, 600px);
        min-width: 300px; /* match main card minimum */
        min-height: 48px; /* auto height based on content */
        border-radius: 28px;
        background: var(--panel-bg);
        box-shadow: inset 0 0 0 1px rgba(0,0,0,0.05);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 6px 14px; /* tighter padding around text */
        box-sizing: border-box;
        z-index: 3;
      }
      .actions-card .actions {
        display: flex;
        gap: 1rem 2rem;
        align-items: center;
        justify-content: space-between;
        width: 100%;
      }
      .actions-right {
        display: flex;
        align-items: center;
        gap: 1rem;
      }
      /* no special swatch styling; using plain text labels */
      .action-sep { display:none; }
      .action-btn, .action-select, .actions-card a.action-btn {
        background: transparent;
        border: none;
        color: inherit;
        font: inherit;
        cursor: pointer;
        text-decoration: none;
        opacity: 0.9;
      }
      /* Override global link gradient styles inside the actions card */
      .actions-card a.action-btn,
      .actions-card a.action-btn:visited {
        color: inherit !important;
        background: none !important;
        -webkit-background-clip: initial !important;
        -webkit-text-fill-color: currentColor !important;
        text-decoration: none;
      }
      .actions-card a.action-btn:hover { text-decoration: none; }
      .bday-panel {
        position: absolute;
        left: 1rem;
        bottom: calc(100% + 6px);
        display: none;
        gap: 8px;
        align-items: center;
        background: var(--panel-bg);
        border-radius: 14px;
        box-shadow: inset 0 0 0 1px rgba(0,0,0,0.05);
        padding: 6px 8px;
      }
      @media (prefers-color-scheme: dark) {
        .actions-card, .bday-panel { background: #141413; box-shadow: inset 0 0 0 1px rgba(255,255,255,0.06); color: var(--accent-dark, #EEEEEC); }
        .actions-card a.action-btn,
        .actions-card a.action-btn:hover,
        .actions-card a.action-btn:visited {
          color: inherit !important;
          background: none !important;
          -webkit-background-clip: initial !important;
          -webkit-text-fill-color: currentColor !important;
        }
      }
    </style>
  </head>
  <body>
    <div class="card">
      <div id="grid" class="grid" aria-label="Days of the year"></div>
      <div class="bottom">
        <span id="year"></span>
        <span id="right-info"></span>
      </div>
    </div>
    <div class="actions-card">
      <div class="actions">
        <div class="actions-left">
          <button id="bdayBtn" aria-label="Calculate your life left" class="action-btn">Your life left</button>
        </div>
        <div class="actions-right">
          <button id="colorBtn" class="action-btn" aria-label="Change color">Color</button>
          <button id="symbolBtn" class="action-btn" aria-label="Change symbol">Symbol</button>
          <button id="shareBtn" aria-label="Share snapshot" class="action-btn">Share</button>
          <a id="appBtn" class="action-btn" href="https://apps.apple.com/us/app/left-widgets-for-time-left/id6740155884" target="_blank" rel="noopener">Get the app</a>
        </div>
      </div>
      <div id="bdayPanel" class="bday-panel">
        <select id="bdayMonth" class="action-select"></select>
        <select id="bdayYear" class="action-select"></select>
        <button id="bdayConfirm" class="action-btn">Calculate</button>
      </div>
    </div>

    <!-- html2canvas for snapshotting the card -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

    <script>
      (function () {
        const grid = document.getElementById('grid');
        const yearEl = document.getElementById('year');
        const infoEl = document.getElementById('right-info');
        const shareBtn = document.getElementById('shareBtn');
        const colorBtn = document.getElementById('colorBtn');
        const symbolBtn = document.getElementById('symbolBtn');
        const bdayBtn = document.getElementById('bdayBtn');
        const bdayPanel = document.getElementById('bdayPanel');
        const bdayMonth = document.getElementById('bdayMonth');
        const bdayYear = document.getElementById('bdayYear');
        const bdayConfirm = document.getElementById('bdayConfirm');

        const now = new Date();
        const y = now.getFullYear();
        const m = now.getMonth();
        const DAY_MS = 86400000;

        // Helpers
        const monthsShort = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const monthsFull  = ['January','February','March','April','May','June','July','August','September','October','November','December'];
        const ordinal = n => { const s = ["th","st","nd","rd"], v = n % 100; return n + (s[(v - 20) % 10] || s[v] || s[0]); };
        const formatDate = d => `${ordinal(d.getUTCDate())} ${monthsShort[d.getUTCMonth()]}, ${d.getUTCFullYear()}`;

        function yearState() {
          const startUTC = Date.UTC(y, 0, 1);
          const nextStartUTC = Date.UTC(y + 1, 0, 1);
          const totalDays = Math.round((nextStartUTC - startUTC) / DAY_MS);
          const todayIndex = Math.floor((Date.UTC(y, now.getMonth(), now.getDate()) - startUTC) / DAY_MS);
          const daysLeft = totalDays - (todayIndex + 1);
          return { labelLeft: String(y), startUTC, totalDays, todayIndex, cols: 15, rows: 25, daysLeft };
        }

        function monthState() {
          const startUTC = Date.UTC(y, m, 1);
          const nextStartUTC = Date.UTC(y, m + 1, 1);
          const totalDays = Math.round((nextStartUTC - startUTC) / DAY_MS);
          const todayIndex = Math.floor((Date.UTC(y, now.getMonth(), now.getDate()) - startUTC) / DAY_MS);
          const cols = 7;
          const rows = Math.ceil(totalDays / cols);
          const daysLeft = Math.max(0, totalDays - (todayIndex + 1));
          return { labelLeft: monthsFull[m], startUTC, totalDays, todayIndex, cols, rows, daysLeft };
        }

        let mode = 'year';
        let state = yearState();

        let showPercent = false; // right label mode

        // Theme colors and symbols
        const themes = [
          { name: 'Monochrome', light: '#f7f7f4', dark: '#EEEEEC' },
          { name: 'Red',        light: '#FADADA', dark: '#FF6B6B' },
          { name: 'Blue',       light: '#EAF0F9', dark: '#6BA8FF' },
          { name: 'Green',      light: '#E9F5EC', dark: '#4CAF6B' },
          { name: 'Purple',     light: '#F0EAF9', dark: '#A07CFF' },
          { name: 'Orange',     light: '#FBE7DA', dark: '#FFA347' },
        ];
        const symbols = [
          { key: 'dot', label: 'Dot' },
          { key: 'square', label: 'Square', char: '■' },
          { key: 'triangle', label: 'Triangle', char: '▲' },
          { key: 'star', label: 'Star', char: '★' },
          { key: 'hexagon', label: 'Hexagon', char: '⬢' },
        ];
        let themeIndex = 0;
        let symbolIndex = 0; // 0 = dot

        function applyTheme() {
          const t = themes[themeIndex];
          const isDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
          if (isDark) {
            document.documentElement.style.setProperty('--accent-dark', t.dark);
            document.documentElement.style.setProperty('--footer-color', t.dark);
          } else {
            document.documentElement.style.setProperty('--panel-bg', t.light);
            document.documentElement.style.setProperty('--footer-color', 'inherit');
          }
          try { localStorage.setItem('left_theme_index', String(themeIndex)); } catch(_) {}
        }

        function currentSymbol() { return symbols[symbolIndex]; }
        function isGlyphSymbol() { return currentSymbol().key !== 'dot'; }
        function toggleColor() { themeIndex = (themeIndex + 1) % themes.length; applyTheme(); }
        function toggleSymbol() { symbolIndex = (symbolIndex + 1) % symbols.length; renderGrid(); try { localStorage.setItem('left_symbol_index', String(symbolIndex)); } catch(_) {} }

        function updateActionLabels() {
          // Keep plain word labels
          symbolBtn.textContent = 'Symbol';
          colorBtn.textContent = 'Color';
          try {
            const sym = currentSymbol();
            symbolBtn.setAttribute('aria-label', 'Change symbol: ' + sym.label);
            const t = themes[themeIndex];
            colorBtn.setAttribute('aria-label', 'Change color: ' + t.name);
          } catch(_) {}
        }

        function rightText() {
          if (!state) return '';
          if (showPercent) {
            const pct = state.totalDays ? Math.max(0, Math.min(100, Math.round((state.daysLeft / state.totalDays) * 100))) : 0;
            return pct + '% left';
          }
          const unit = state.kind === 'life' ? 'years' : 'days';
          return state.daysLeft + ' ' + unit + ' left';
        }

        function renderGrid() {
          grid.innerHTML = '';
          grid.style.gridTemplateColumns = `repeat(${state.cols}, var(--dot-size))`;
          for (let i = 0; i < state.totalDays; i++) {
            const dot = document.createElement('div');
            const past = (i <= state.todayIndex);
            if (isGlyphSymbol()) {
              dot.className = 'dot glyph' + (past ? ' past' : '');
              const sym = currentSymbol();
              dot.textContent = sym.char || '•';
              // Make square and hexagon visually larger
              if (sym.key === 'square' || sym.key === 'hexagon') {
                dot.style.fontSize = `calc(${getComputedStyle(document.documentElement).getPropertyValue('--dot-size').trim()} * 2)`;
              }
            } else {
              dot.className = 'dot' + (past ? ' past' : '');
            }
            if (state.kind === 'life') {
              dot.title = String(state.birthYear + i);
            } else {
              const d = new Date(state.startUTC + i * DAY_MS);
              dot.title = formatDate(d);
            }
            grid.appendChild(dot);
          }

          yearEl.textContent = state.labelLeft;
          infoEl.textContent = rightText();
          recalcGap();
          updateActionLabels();
        }

        // Hover handlers: show date of hovered dot; revert on leave
        grid.addEventListener('mouseover', (e) => {
          const t = e.target;
          if (t && t.classList && t.classList.contains('dot')) {
            infoEl.textContent = t.title;
          }
        });
        grid.addEventListener('mouseout', (e) => {
          const t = e.target;
          if (t && t.classList && t.classList.contains('dot')) {
            infoEl.textContent = rightText();
          }
        });

        // Tap/click on the left label to toggle between year and current month
        yearEl.addEventListener('click', () => {
          mode = mode === 'year' ? 'month' : 'year';
          state = mode === 'year' ? yearState() : monthState();
          renderGrid();
        });

        // Birthday flow → Life mode (7x12 = 84 years)
        function lifeState(birth) {
          const birthDate = new Date(birth.getFullYear(), birth.getMonth(), birth.getDate());
          const birthYear = birthDate.getFullYear();
          const targetLifespan = 84; // years
          // Completed years
          const today = new Date();
          let yearsCompleted = today.getFullYear() - birthYear;
          // Adjust if before birthday this year
          const hadBirthday = (today.getMonth() > birth.getMonth()) || (today.getMonth() === birth.getMonth() && today.getDate() >= birth.getDate());
          if (!hadBirthday) yearsCompleted -= 1;
          yearsCompleted = Math.max(0, Math.min(targetLifespan, yearsCompleted));
          const yearsLeft = Math.max(0, targetLifespan - yearsCompleted);

          return {
            kind: 'life',
            labelLeft: 'My life',
            totalDays: targetLifespan,
            todayIndex: yearsCompleted - 1, // mark completed years as past
            cols: 7,
            rows: 12,
            daysLeft: yearsLeft,
            birthYear
          };
        }

        function startLifeModeWith(input) {
          try {
            const d = input instanceof Date ? input : new Date(input);
            if (isNaN(d.getTime())) return;
            mode = 'life';
            state = lifeState(d);
            // Persist
            try {
              const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; // YYYY-MM
              localStorage.setItem('left_birthdate', key);
            } catch (_) {}
            renderGrid();
          } catch (_) {}
        }

        // Populate dropdowns
        (function initBirthdayDropdowns(){
          const monthsFull  = ['January','February','March','April','May','June','July','August','September','October','November','December'];
          bdayMonth.innerHTML = monthsFull.map((m, i) => `<option value="${i}">${m}</option>`).join('');
          const thisYear = new Date().getFullYear();
          const years = [];
          for (let yv = thisYear; yv >= 1945; yv--) years.push(`<option value="${yv}">${yv}</option>`);
          bdayYear.innerHTML = years.join('');
        })();

        // Hook up birthday button and panel
        bdayBtn.addEventListener('click', () => {
          // Load saved value, if any
          try {
            const saved = localStorage.getItem('left_birthdate');
            if (saved) {
              const [yy, mm] = saved.split('-').map(Number);
              if (yy && mm) { bdayYear.value = String(yy); bdayMonth.value = String(mm-1); }
            }
          } catch(_){}
          bdayPanel.style.display = bdayPanel.style.display === 'none' ? 'flex' : 'none';
          positionShareButton();
        });
        bdayConfirm.addEventListener('click', () => {
          const yy = parseInt(bdayYear.value, 10);
          const mm = parseInt(bdayMonth.value, 10);
          if (!isNaN(yy) && !isNaN(mm)) {
            startLifeModeWith(new Date(yy, mm, 1));
            bdayPanel.style.display = 'none';
          }
        });
        // Autoload life mode if previously stored
        try {
          const saved = localStorage.getItem('left_birthdate');
          if (saved) {
            const [yy, mm] = saved.split('-').map(Number);
            if (yy && mm) startLifeModeWith(new Date(yy, mm-1, 1));
          }
        } catch(_) {}

        // Toggle right label between days left and % left
        infoEl.addEventListener('click', () => {
          showPercent = !showPercent;
          infoEl.textContent = rightText();
        });

        // Compute gap so the grid uses 90% of card height, never resizing dots
        function recalcGap() {
          const sample = grid.querySelector('.dot');
          if (!sample) return;
          const dotPx = sample.getBoundingClientRect().width || 8;

          const cols = state.cols, rows = state.rows;
          const card = document.querySelector('.card');
          const cs = getComputedStyle(card);
          const paddingX = parseFloat(cs.paddingLeft) + parseFloat(cs.paddingRight);
          const paddingY = parseFloat(cs.paddingTop) + parseFloat(cs.paddingBottom);
          const cardInnerW = Math.max(0, card.clientWidth - paddingX);
          const cardInnerH = Math.max(0, card.clientHeight - paddingY);

          const compute = (cCols, cRows, availW) => {
            const targetH = cardInnerH * 0.9;
            const gapH = (targetH - cRows * dotPx) / (cRows - 1 || 1);
            const gapW = (availW - cCols * dotPx) / (cCols - 1 || 1);
            const gap = Math.max(0, Math.min(gapW, gapH));
            const width = cCols * dotPx + (cCols - 1) * gap;
            return { gap, width };
          };

          // Compute how wide the YEAR grid would be in this viewport
          const yearMetrics = compute(15, 25, cardInnerW);

          // For month view, do not exceed the year width
          const allowedW = mode === 'month' ? Math.min(cardInnerW, yearMetrics.width) : cardInnerW;

          const current = compute(cols, rows, allowedW);
          grid.style.gap = current.gap + 'px';
          grid.style.width = current.width + 'px';
          document.documentElement.style.setProperty('--footer-width', current.width + 'px');
        }

        // Initial and on-resize calculations
        renderGrid();
        window.addEventListener('resize', recalcGap);
        window.addEventListener('orientationchange', recalcGap);

        // No manual positioning needed; actions are in an anchored card

        // Color and Symbol controls
        colorBtn.addEventListener('click', () => { toggleColor(); updateActionLabels(); });
        symbolBtn.addEventListener('click', () => { toggleSymbol(); updateActionLabels(); });

        // Load persisted theme/symbol
        try {
          const ti = parseInt(localStorage.getItem('left_theme_index') || '0', 10);
          if (!Number.isNaN(ti)) { themeIndex = (ti % themes.length + themes.length) % themes.length; }
          const si = parseInt(localStorage.getItem('left_symbol_index') || '0', 10);
          if (!Number.isNaN(si)) { symbolIndex = (si % symbols.length + symbols.length) % symbols.length; }
        } catch(_) {}
        applyTheme();
        updateActionLabels();

        // --- Share: capture card and download ---
        async function shareSnapshot() {
          if (typeof window.html2canvas !== 'function') {
            alert('Sharing not available offline.');
            return;
          }

          // Build an offscreen 2000x2000 export with a square card inside
          const OUTER = 2000; // final image size
          const CARD = 1800;  // inner card a bit smaller
          const EXPORT_DOT = 16; // larger dots for export image

          const exportRoot = document.createElement('div');
          exportRoot.style.position = 'fixed';
          exportRoot.style.left = '-99999px';
          exportRoot.style.top = '0';
          exportRoot.style.width = OUTER + 'px';
          exportRoot.style.height = OUTER + 'px';
          const isDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
          const siteBg = isDark ? '#222222' : '#FDFDFC'; // solid to avoid banding
          exportRoot.style.background = siteBg;
          exportRoot.style.overflow = 'hidden';

          const exportCard = document.createElement('div');
          exportCard.style.position = 'absolute';
          exportCard.style.left = Math.round((OUTER - CARD) / 2) + 'px';
          exportCard.style.top = Math.round((OUTER - CARD) / 2) + 'px';
          exportCard.style.width = CARD + 'px';
          exportCard.style.height = CARD + 'px';
          const cardComp = getComputedStyle(document.querySelector('.card'));
          exportCard.style.background = cardComp.backgroundColor || '#f7f7f4';
          exportCard.style.borderRadius = '80px';
          exportCard.style.boxShadow = 'none'; /* avoid corner artifacts */
          exportCard.style.overflow = 'hidden';
          exportCard.style.boxSizing = 'border-box';
          exportCard.style.border = isDark ? '2px solid rgba(255,255,255,0.08)' : '2px solid rgba(0,0,0,0.06)';
          exportCard.style.display = 'flex';
          exportCard.style.flexDirection = 'column';
          exportCard.style.alignItems = 'center';
          exportCard.style.justifyContent = 'flex-start';
          exportCard.style.padding = '120px';
          exportCard.style.boxSizing = 'border-box';

          const exportGrid = document.createElement('div');
          exportGrid.style.display = 'grid';
          exportGrid.style.gridTemplateColumns = `repeat(${state.cols}, ${EXPORT_DOT}px)`;
          exportGrid.style.margin = '0 auto';

          const exportFooter = document.createElement('div');
          exportFooter.style.position = 'absolute';
          exportFooter.style.bottom = '120px';
          exportFooter.style.display = 'flex';
          exportFooter.style.justifyContent = 'space-between';
          exportFooter.style.opacity = '1';
          exportFooter.style.fontFamily = getComputedStyle(document.body).fontFamily;
          exportFooter.style.fontSize = '36px';

          const leftLabel = document.createElement('span');
          leftLabel.textContent = state.labelLeft;
          const rightLabel = document.createElement('span');
          rightLabel.textContent = rightText();
          exportFooter.appendChild(leftLabel);
          exportFooter.appendChild(rightLabel);

          // Build dots or symbols for export
          const accent = getComputedStyle(document.documentElement).getPropertyValue('--accent-dark').trim() || '#EEEEEC';
          const useGlyph = (function(){
            try { return (document.getElementById('symbolBtn') && (localStorage.getItem('left_symbol_index')|0) !== 0) || (typeof symbolIndex !== 'undefined' && symbolIndex !== 0); } catch(_) { return false; }
          })();
          const symMap = ['•','■','▲','★','⬢'];
          const symChar = symMap[(function(){ try { return (localStorage.getItem('left_symbol_index')|0); } catch(_) { return 0; }})()];
          for (let i = 0; i < state.totalDays; i++) {
            const isPast = i <= state.todayIndex;
            if (useGlyph) {
              const cell = document.createElement('div');
              cell.style.width = EXPORT_DOT + 'px';
              cell.style.height = EXPORT_DOT + 'px';
              cell.style.display = 'flex';
              cell.style.alignItems = 'center';
              cell.style.justifyContent = 'center';
              // Make square/hexagon larger in export
              const exportedSymbolIndex = (function(){ try { return (localStorage.getItem('left_symbol_index')|0); } catch(_) { return 0; }})();
              const baseSize = EXPORT_DOT + 2;
              const fontSize = (exportedSymbolIndex === 1 || exportedSymbolIndex === 4) ? baseSize * 2 : baseSize; // 1=square,4=hexagon
              cell.style.fontSize = fontSize + 'px';
              cell.style.lineHeight = '1';
              cell.style.color = isDark ? accent : '#111110';
              cell.style.opacity = isPast ? '0.5' : '1';
              cell.textContent = symChar || '•';
              exportGrid.appendChild(cell);
            } else {
              const dot = document.createElement('div');
              dot.style.width = EXPORT_DOT + 'px';
              dot.style.height = EXPORT_DOT + 'px';
              dot.style.borderRadius = '50%';
              dot.style.background = isDark ? accent : '#111110';
              dot.style.opacity = isPast ? '0.5' : '1';
              exportGrid.appendChild(dot);
            }
          }

          // Footer color in dark mode uses accent
          if (isDark) { exportFooter.style.color = accent; }

          exportCard.appendChild(exportGrid);
          exportCard.appendChild(exportFooter);
          exportRoot.appendChild(exportCard);
          document.body.appendChild(exportRoot);

          // Compute spacing inside export card to center-top grid and align footer width
          (function calcExportLayout(){
            const dotPx = EXPORT_DOT; // fixed for export
            const padding = 120 * 2; // left+right and top+bottom equal
            const innerW = CARD - padding;
            const innerH = CARD - padding;

            const compute = (cols, rows, availW) => {
              const targetH = innerH * 0.9;
              const gapH = (targetH - rows * dotPx) / (rows - 1 || 1);
              const gapW = (availW - cols * dotPx) / (cols - 1 || 1);
              const gap = Math.max(0, Math.min(gapW, gapH));
              const gridW = cols * dotPx + (cols - 1) * gap;
              return { gap, gridW };
            };

            // Base: compute how wide the YEAR grid would be in this export card
            const yearBase = compute(15, 25, innerW);

            // Current grid (month or year) is capped to the year width
            const cols = state.cols, rows = state.rows;
            const capped = compute(cols, rows, Math.min(innerW, yearBase.gridW));

            exportGrid.style.gap = capped.gap + 'px';
            exportGrid.style.width = capped.gridW + 'px';

            // Footer matches grid width and is centered horizontally
            exportFooter.style.width = capped.gridW + 'px';
            const left = Math.round((CARD - capped.gridW) / 2);
            exportFooter.style.left = left + 'px';
          })();

          const canvas = await window.html2canvas(exportRoot, {
            backgroundColor: siteBg,
            scale: 1,
            width: OUTER,
            height: OUTER
          });

          // Cleanup the offscreen DOM
          exportRoot.remove();

          canvas.toBlob((blob) => {
            if (!blob) return;
            const a = document.createElement('a');
            const modeLabel = yearEl.textContent.trim();
            a.download = `left-${modeLabel.replace(/\s+/g,'-').toLowerCase()}.png`;
            a.href = URL.createObjectURL(blob);
            document.body.appendChild(a);
            a.click();
            URL.revokeObjectURL(a.href);
            a.remove();
          }, 'image/png');
        }
        shareBtn.addEventListener('click', shareSnapshot);
      })();
    </script>
  </body>
  </html>
