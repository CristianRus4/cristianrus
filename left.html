<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Year Left</title>
    <link rel="stylesheet" type="text/css" href="style.css" />
    <style>
      :root {
        /* Fixed sizes: dots never change size */
        --dot-size: 8px;
        --gap: 6px; /* updated by JS; only spacing changes */
      }

      /* App-specific layout (minimal; uses site styles) */
      .card {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: min(90vw, 600px);
        height: 80vh; /* always 80% viewport height */
        min-width: 300px; /* enforce minimum width; grid/footer follow */
        border-radius: 28px;
        background: #f7f7f4;
        box-shadow: inset 0 0 0 1px rgba(0,0,0,0.05);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start; /* grid top aligned */
        padding: 2rem;
        box-sizing: border-box;
        overflow: hidden; /* keep content inside */
        z-index: 1;
      }

      .grid {
        display: grid;
        grid-auto-rows: var(--dot-size);
        gap: var(--gap); /* updated by JS */
        margin: 0; /* positioned by card */
      }

      .dot {
        width: var(--dot-size);
        height: var(--dot-size);
        border-radius: 50%;
        background: #111110; /* visible in light mode too (site text color is dark) */
      }
      .dot.past { opacity: 0.5; }

      /* Bottom labels pinned to viewport edges (match site padding) */
      .bottom {
        position: absolute; /* inside the card */
        bottom: 1.25rem;
        left: 50%;
        transform: translateX(-50%);
        width: var(--footer-width, auto);
        display: flex;
        justify-content: space-between;
        align-items: center;
        opacity: 1; /* match full-opacity future dots */
        font-size: 0.95em;
        pointer-events: auto; /* allow clicking/tapping labels */
        z-index: 2;
      }

      /* Respect dark mode */
      @media (prefers-color-scheme: dark) {
        .dot { background: #EEEEEC; }
        .card {
          background: #141413;
          box-shadow: inset 0 0 0 1px rgba(255,255,255,0.06);
        }
        .bottom { opacity: 1; }
      }
    </style>
  </head>
  <body>
    <div class="card">
      <div id="grid" class="grid" aria-label="Days of the year"></div>
      <div class="bottom">
        <span id="year"></span>
        <span id="right-info"></span>
      </div>
    </div>

    <script>
      (function () {
        const grid = document.getElementById('grid');
        const yearEl = document.getElementById('year');
        const infoEl = document.getElementById('right-info');

        const now = new Date();
        const y = now.getFullYear();
        const m = now.getMonth();
        const DAY_MS = 86400000;

        // Helpers
        const monthsShort = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const monthsFull  = ['January','February','March','April','May','June','July','August','September','October','November','December'];
        const ordinal = n => { const s = ["th","st","nd","rd"], v = n % 100; return n + (s[(v - 20) % 10] || s[v] || s[0]); };
        const formatDate = d => `${ordinal(d.getUTCDate())} ${monthsShort[d.getUTCMonth()]}, ${d.getUTCFullYear()}`;

        function yearState() {
          const startUTC = Date.UTC(y, 0, 1);
          const nextStartUTC = Date.UTC(y + 1, 0, 1);
          const totalDays = Math.round((nextStartUTC - startUTC) / DAY_MS);
          const todayIndex = Math.floor((Date.UTC(y, now.getMonth(), now.getDate()) - startUTC) / DAY_MS);
          const daysLeft = totalDays - (todayIndex + 1);
          return { labelLeft: String(y), startUTC, totalDays, todayIndex, cols: 15, rows: 25, daysLeft };
        }

        function monthState() {
          const startUTC = Date.UTC(y, m, 1);
          const nextStartUTC = Date.UTC(y, m + 1, 1);
          const totalDays = Math.round((nextStartUTC - startUTC) / DAY_MS);
          const todayIndex = Math.floor((Date.UTC(y, now.getMonth(), now.getDate()) - startUTC) / DAY_MS);
          const cols = 7;
          const rows = Math.ceil(totalDays / cols);
          const daysLeft = Math.max(0, totalDays - (todayIndex + 1));
          return { labelLeft: monthsFull[m], startUTC, totalDays, todayIndex, cols, rows, daysLeft };
        }

        let mode = 'year';
        let state = yearState();

        let showPercent = false; // right label mode

        function rightText() {
          if (!state) return '';
          if (showPercent) {
            const pct = state.totalDays ? Math.max(0, Math.min(100, Math.round((state.daysLeft / state.totalDays) * 100))) : 0;
            return pct + '% left';
          }
          return state.daysLeft + ' days left';
        }

        function renderGrid() {
          grid.innerHTML = '';
          grid.style.gridTemplateColumns = `repeat(${state.cols}, var(--dot-size))`;
          for (let i = 0; i < state.totalDays; i++) {
            const dot = document.createElement('div');
            dot.className = 'dot' + (i <= state.todayIndex ? ' past' : '');
            const d = new Date(state.startUTC + i * DAY_MS);
            dot.title = formatDate(d);
            grid.appendChild(dot);
          }

          yearEl.textContent = state.labelLeft;
          infoEl.textContent = rightText();
          recalcGap();
        }

        // Hover handlers: show date of hovered dot; revert on leave
        grid.addEventListener('mouseover', (e) => {
          const t = e.target;
          if (t && t.classList && t.classList.contains('dot')) {
            infoEl.textContent = t.title;
          }
        });
        grid.addEventListener('mouseout', (e) => {
          const t = e.target;
          if (t && t.classList && t.classList.contains('dot')) {
            infoEl.textContent = rightText();
          }
        });

        // Tap/click on the left label to toggle between year and current month
        yearEl.addEventListener('click', () => {
          mode = mode === 'year' ? 'month' : 'year';
          state = mode === 'year' ? yearState() : monthState();
          renderGrid();
        });

        // Toggle right label between days left and % left
        infoEl.addEventListener('click', () => {
          showPercent = !showPercent;
          infoEl.textContent = rightText();
        });

        // Compute gap so the grid uses 90% of card height, never resizing dots
        function recalcGap() {
          const sample = grid.querySelector('.dot');
          if (!sample) return;
          const dotPx = sample.getBoundingClientRect().width || 8;

          const cols = state.cols, rows = state.rows;
          const card = document.querySelector('.card');
          const cs = getComputedStyle(card);
          const paddingX = parseFloat(cs.paddingLeft) + parseFloat(cs.paddingRight);
          const paddingY = parseFloat(cs.paddingTop) + parseFloat(cs.paddingBottom);
          const cardInnerW = Math.max(0, card.clientWidth - paddingX);
          const cardInnerH = Math.max(0, card.clientHeight - paddingY);

          const compute = (cCols, cRows, availW) => {
            const targetH = cardInnerH * 0.9;
            const gapH = (targetH - cRows * dotPx) / (cRows - 1 || 1);
            const gapW = (availW - cCols * dotPx) / (cCols - 1 || 1);
            const gap = Math.max(0, Math.min(gapW, gapH));
            const width = cCols * dotPx + (cCols - 1) * gap;
            return { gap, width };
          };

          // Compute how wide the YEAR grid would be in this viewport
          const yearMetrics = compute(15, 25, cardInnerW);

          // For month view, do not exceed the year width
          const allowedW = mode === 'month' ? Math.min(cardInnerW, yearMetrics.width) : cardInnerW;

          const current = compute(cols, rows, allowedW);
          grid.style.gap = current.gap + 'px';
          grid.style.width = current.width + 'px';
          document.documentElement.style.setProperty('--footer-width', current.width + 'px');
        }

        // Initial and on-resize calculations
        renderGrid();
        window.addEventListener('resize', recalcGap);
        window.addEventListener('orientationchange', recalcGap);
      })();
    </script>
  </body>
  </html>
